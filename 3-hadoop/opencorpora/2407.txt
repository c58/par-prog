Оказывается, я так до сих пор и не реализовал правильно остановку нитей. Проблемы связаны с вызовом лиспового кода сишной функцией funcall: неправильно изменяется состояние нити (нить входит в лисповый код, поэтому флаг gc_safe должен быть сброшен, но этого не происходит => сборщик мусора пропускает такую нить, и начинает сборку при работающем мутаторе кучи). Также, по-видимому, неправильно обрабатывается изменение состояния нити при раскрутке стека. Видимо, gc_safe стоит вынести из структуры нити и сделать символом; это обеспечит корректное изменение при раскрутке стека и прочих изменениях состояния нити, т.к. стек динамических привязок и так поддерживается в правильном состоянии.
Немного попилил сокеты под виндой. Они очень странные. Так, например, нельзя просто так читать, ожидать и писать в сокеты из разных нитей - если чтение/ожидание началось раньше записи, то запись в сокет не будет произведена, пока не завершится чтение/ожидание. Поэтому, например, без особых ухищрений Slime не работает в многонитевом режиме, т.к. в нем одна нить читает из сокета, а другая - пишет в сокет. Обращаться к асинхронному вводу-выводу очень не хочется.
