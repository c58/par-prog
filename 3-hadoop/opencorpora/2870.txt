Продолжаю ковырять SBCL на предмет ниток в Win32. Указателя на область TLS хранится в поле Arbitrary Data Slot, которое для каждой нити всегда доступно по адресу FS:0x14. Часть VOP'ов из-за этого занимает больше инструкций и используют больше регистров и обращений к памяти - в других портах SBCL может сразу адресовать область TLS, а Win32 надо еще загрузить в регистр указатель на эту область. Пока сложно оценить, насколько это повлияет на быстродействие.
Собственная невнимательность мне всегда мешает. На отладку потратил всю неделю, а все по невнимательности. Зато узнал, что GDB - очень удобный отладчик. За неприметным текстовым интерфейсом это сразу сложно разглядеть. В GDB можно писать макросы, за счет чего он быстро обрастает оснасткой для конкретных приложений. Раньше я интенсивно использовал лишь отладчик в Visual Studio, и не ожидал, что GDB будет настолько удобным.
Что касается SBCL, то сегодня он впервые полностью собрался и заработал (раньше доходил только до начала cold init'а). TLS, судя по всему, работает.
Теперь нужно допилить рантайм, научить его останавливать создавать нити и останавливать их при сборке мусора.
Для остановки нитей буду помещать в контекст нити фиктивный вызов функции (plant_stack.c), в которой ждать сигнала к пробуждению. Это позволит корректно останавливать как нити, находящиеся в блокирующем системном вызове, так и нити, находящиеся в юзерспейсе.
